{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% load humanize %}
{% load index_tag %}

{% block css %}
  <link rel="stylesheet" href="{% static 'styles/product_detail.css' %}">
{% endblock css %}

{% block body %}
  {% comment %} breadcrumb {% endcomment %}
  <nav class='pdt-breadcrumb' style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/">홈</a>
      </li>
      <li class="breadcrumb-item">
        {% if product.category == '노트/메모지' %}
        <a href="{% url 'products:note' %}">
          {{ product.category }}
        </a>
        {% elif product.category == '다이어리' %}
        <a href="{% url 'products:diary' %}">
          {{ product.category }}
        </a>
        {% elif product.category == '필기류/필통' %}
        <a href="{% url 'products:pencil' %}">
          {{ product.category }}
        </a>
        {% elif product.category == '파일/바인더' %}
        <a href="{% url 'products:file' %}">
          {{ product.category }}
        </a>
        {% endif %}
      </li>
      <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
    </ol>
  </nav>
  <main id="product-detail" >
    {% comment %} 상품 정보 {% endcomment %}
    <section class='row row-cols-2'>
      {% comment %} 상품 이미지 {% endcomment %}
      <div class='col'>
        <div class='row g-1'>
          <div class='col-2'>
            {% for productimage in product.product_image.all %}
            <img class='pdt-img' src="{{ productimage.image.url }}" alt="">
            {% endfor %}
          </div>
          <div class='col-10'>
            <img class='pdt-first-img' src="{{product.product_image.all.0.image.url }}" alt="">
          </div>
        </div>
      </div>
      {% comment %} 상품 기본 정보 {% endcomment %}
      <div class='col'>
        <div class='pdt-category-like'>
          <p class='pdt-category'>{{ product.category }}</p>
          <!-- 찜하기 비동기 구현 -->
          {% if request.user.is_authenticated %}
            <div class='pdt-like'>
              <form class="like-forms" data-product-id="{{ product.pk }}">
                {% csrf_token %}
                {% if user in product.like_users.all %}
                  <button type="submit" class="" id="like-{{ product.pk }}">
                    <i id="heart-{{ product.pk }}" class="bi bi-bookmark-heart-fill"></i>
                  </button>
                {% else %}
                  <button type="submit" class="" id="like-{{ product.pk }}">
                    <i id="heart-{{ product.pk }}" class="bi bi-bookmark-heart"></i>
                  </button>
                {% endif %}
              </form>
              <div id="heart-count">
                <p>{{ product.like_users.count }}</p>
              </div>
            </div>
          {% endif %}
        </div>
        <p class='pdt-name'>{{ product.name }}</p>
        <hr>
        <div class='pdt-price'>
          {% if product.sale != 0 %}
          <span class='pdt-sale'>{{ product.sale }}%</span>
          {% endif %}
          <span class='pdt-pay'>{{ product.pay|discount:product.sale|intcomma }}원</span>
          {% if product.sale != 0 %}
          <del class='before-sale'>{{ product.pay|intcomma }}원</del>
          {% endif %}
        </div>
        <div class='stars-container'>
          <div class='stars'>
            <div class='stars-background'>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
            </div>
            <div class='stars-color' data-avg-grade='{{ total.review_avg|floatformat }}'>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
            </div>
          </div>
          <div class='pdt-review-cnt-wrap'>
            <span class='pdt-review-cnt'>{{ reviews.count }}</span>개의 리뷰
          </div>
        </div>
        <table class='purchase-table'>
          <tr>
            <th>배송비</th>
            <td>{{ product.delivery|intcomma }}원</td>
          </tr>
          <tr>
            <th>수량</th>
            <td class='buy-mount-btn'>
              <span class='minus-btn'>-</span>
              <span class='buy-mount'>0</span>
              <span class='plus-btn'>+</span>
            </td>
          </tr>
        </table>
        <div class='total-purchase-price-wrap'>
          <span>주문 금액</span>
          <span class='total-purchase-price' data-delivery='{{ product.delivery }}' data-price='{{ product.pay }}' data-sale='{{ product.sale }}'>0원</span>
        </div>
        <div class='basket-buy-btn-wrap'>
          <a class='basket-btn' href="{% url "cart:add_cart" products.pk %}">장바구니</a>
          <a class='buy-btn' href="">바로구매</a>
        </div>
      </div>
    </section>
    {% comment %} 상품정보/리뷰/문의/추천 탭 {% endcomment %}
    <section>
      {% comment %} 탭 {% endcomment %}
      <ul class='pdt-4tab'>
        <li class='tab active'>
          <a href="#pdt-info">상품정보</a>
        </li>
        <li class='tab'>
          <a href="#pdt-review">리뷰
            <span class='small-count'>{{ reviews.count }}</span>
          </a>
        </li>
        <li class='tab'>
          <a href="#pdt-qna">문의
            <span class='small-count'></span>
          </a>
        </li>
        <li class='tab'>
          <a href="#pdt-recommend">추천</a>
        </li>
      </ul>
      <div class='row g-2'>
        <div class='col-8'>
          {% comment %} 상품정보 {% endcomment %}
          <article id='pdt-info'>
            <h3>상품정보</h3>
            <img src="{{ product.Description2.url }}" alt="">
          </article>
          {% comment %} 리뷰 {% endcomment %}
          <article id='pdt-review'>
            <div class="pdt-rev-titarea">
              <h3>리뷰 <span class='small-count'>{{ reviews.count }}</span></h3>
              <p id="rev-modal-btn">리뷰쓰기</p>
            </div>
            <div class='review-grade-wrap'>
              <div class='stars-container'>
                <div class='stars'>
                  <div class='stars-background'>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                  </div>
                  <div class='stars-color' data-avg-grade='{{ total.review_avg }}'>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                  </div>
                </div>
                <div class='avg-grade'>
                  {% if total.review_avg %}
                  {{ total.review_avg }}
                  {% else %}
                  {{ 0 }}
                  {% endif %}
                </div>
              </div>
              <div class='grade-bar-container d-none d-lg-block'>
                <div class='grade-bar-item'>
                  <span>5점</span>
                  <div class='grade-bar'>
                    <div class='grade-bar-background'>
                    </div>
                    <div class='grade-bar-color-wrap'>
                      <div class='grade-bar-color'></div>
                    </div>
                  </div>
                  <span class='pdt-review-grade-count'>{% if grades_5.0 %}{{grades_5.0.gra}}{% else %}0{% endif %}</span>
                </div>
                <div class='grade-bar-item'>
                  <span>4점</span>
                  <div class='grade-bar'>
                    <div class='grade-bar-background'>
                    </div>
                    <div class='grade-bar-color-wrap'>
                      <div class='grade-bar-color'></div>
                    </div>
                  </div>
                  <span class='pdt-review-grade-count'> {% if grades_4.0 %}{{grades_4.0.gra}}{% else %}0{% endif %}</span>
                </div>
                <div class='grade-bar-item'>
                  <span>3점</span>
                  <div class='grade-bar'>
                    <div class='grade-bar-background'>
                    </div>
                    <div class='grade-bar-color-wrap'>
                      <div class='grade-bar-color'></div>
                    </div>
                  </div>
                  <span class='pdt-review-grade-count'>{% if grades_3.0 %}{{grades_3.0.gra}}{% else %}0{% endif %}</span>
                </div>
                <div class='grade-bar-item'>
                  <span>2점</span>
                  <div class='grade-bar'>
                    <div class='grade-bar-background'>
                    </div>
                    <div class='grade-bar-color-wrap'>
                      <div class='grade-bar-color'></div>
                    </div>
                  </div>
                  <span class='pdt-review-grade-count'>{% if grades_2.0 %}{{grades_2.0.gra}}{% else %}0{% endif %}</span>
                </div>
                <div class='grade-bar-item'>
                  <span>1점</span>
                  <div class='grade-bar'>
                    <div class='grade-bar-background'>
                    </div>
                    <div class='grade-bar-color-wrap'>
                      <div class='grade-bar-color'></div>
                    </div>
                  </div>
                  <span class='pdt-review-grade-count'>{% if grades_1.0 %}{{grades_1.0.gra}}{% else %}0{% endif %}</span>
                </div>
              </div>
            </div>
            <div id="review-area">
              {% if reviews %}
              {% for review in reviews %}
              <div class="rev-sec">
                <div class="rev-prof-img">
                  {% if user.profile_image %}
                  <img class="profile__img" src="{{user.profile_image.url}}" alt="profile-img" />
                  {% else %}
                  <img class="profile__img" src="{% static 'img/profile_dummy.jpg' %}" alt="profile-img" />
                  {% endif %}
                </div>
                <div class="rev-main">
                  <div class="rev-header">
                    <p class="rev-user">{{review.account.nickname}}</p>
                    <p class="rev-date">{{review.created_at|date:'Y.m.d' }}</p>
                    <p class="rev-rate">
                      <i class="bi bi-star{% if review.grade >= 1 %}-fill{% elif 0 < review.grade and review.grade < 1 %}{% endif %}"></i>
                      <i class="bi bi-star{% if review.grade >= 2 %}-fill{% elif 0 < review.grade and review.grade < 2 %}{% endif %}"></i>
                      <i class="bi bi-star{% if review.grade >= 3 %}-fill{% elif 0 < review.grade and review.grade < 3 %}{% endif %}"></i>
                      <i class="bi bi-star{% if review.grade >= 4 %}-fill{% elif 0 < review.grade and review.grade < 4 %}{% endif %}"></i>
                      <i class="bi bi-star{% if review.grade >= 5 %}-fill{% elif 0 < review.grade and review.grade < 5 %}{% endif %}"></i>
                    </p>
                  {% if request.user.is_authenticated and request.user.pk == review.account.pk %}
                    <div class="rev-btn">
                      <a href="{% url 'reviews:update' review.pk %}">수정</a>
                      <a href=" {% url 'reviews:delete' review.pk   %} ">삭제</a>
                    </div>
                  {% endif %}
                  </div>
                  <div class="rev-body">
                    <p>{{review.title}}</p>
                    <p class="rev-cont">
                      {{review.content}}
                    </p>
                    {% if review.review_image %}
                    <img src="{{ review.review_image.url }}" alt="" class="rev-img" onclick="window.open(this.src)">
                    {% endif %}
                  </div>
                  <div class="rev-footer">
                    {% if request.user in review.like.all %}
                    <button  class="like-btn" >
                      <span class="like-cnt">
                        {{review.like.count}}
                      </span>
                      <i class="bi bi-hand-thumbs-up-fill" data-review-id="{{ review.pk }}"></i>
                    </button>
                    {% else %}
                    <button class="like-btn">
                      <span class="like-cnt">
                        {{review.like.count}}
                        {{review.pk}}
                      </span>
                      <i class="bi bi-hand-thumbs-up" data-review-id="{{ review.pk }}"></i>
                    </button>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div class="rev-sec">
                <p>아직 작성된 리뷰가 없어요 :(</p>
              </div>
              {% endif %}

            </div>
          </article>
          {% comment %} 문의 {% endcomment %}
          <article id='pdt-qna'>
            <div class="pdt-qna-titarea">
              <h3>문의 <span class='small-count'></span></h3>
              <p class="qna-modal-btn">문의하기</p>            
            </div>
            <div id="qna-area">
              <div class="qna-sec">
                <div class="qna-header">
                  <p class="qna-info">
                    <span>구매 |</span>
                    <span>배송 |</span>
                    <span class="qna-status">미답변</span>
                  </p>
                  <p class="qna-user">
                    <span>username |</span>
                    <span>2022년 11월 09일 22시 07분</span>
                  </p>
                </div>
                <div class="qna-main">
                  <div class="qna-cont qna-q">
                    <span>Q.</span>
                    <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Nam, at. Ipsa voluptatibus ipsum alias, vitae rem assumenda magni pariatur facere quam illo eveniet iusto facilis nam, provident quisquam dicta consectetur?</p>
                  </div>
                  <div class="qna-cont qna-a">
                    <span>A.</span>
                    <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Nam, at. Ipsa voluptatibus ipsum alias, vitae rem assumenda magni pariatur facere quam illo eveniet iusto facilis nam, provident quisquam dicta consectetur?</p>
                  </div>
                </div>
              </div>
            </div>
          </article>
          {% comment %} 추천 {% endcomment %}
          <article id='pdt-recommend'>
            <h3>추천</h3>
            <div class='pdt-list row row-cols-1 row-cols-md-2 row-cols-lg-3 gx-0 gy-3'>
              {% for product in recommend_products %}
              <div class='col'>
                <div class='pdt-item'>
                  <a class='pdt-item-img-wrap' href="{% url 'products:products_detail' product.pk %}">
                    <img class='pdt-item-img' src="{{ product.product_image.all.0.image.url }}" alt="">
                  </a>
                  <a class='pdt-item-name' href="{% url 'products:products_detail' product.pk %}">
                    {{ product.name }}
                  </a>
                  <div class='pdt-item-price'>
                    {% if product.sale != 0 %}
                    <del class='before-sale'>{{ product.pay|intcomma }}원</del>
                    {% endif %}
                    <span class='pdt-pay'>{{ product.pay|discount:product.sale|intcomma }}원</span>
                  </div>
                  {% if product.sale != 0 %}
                  <div class='pdt-sale-badge'>
                    {{ product.sale }}%
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </article>
        </div>
        <div class='col-4'>
          <div class='basket-buy-btn-wrap small'>
            <a class='basket-btn' href="{% url "cart:add_cart" products.pk %}">장바구니</a>
            <a class='buy-btn' href="">바로구매</a>
          </div>
        </div>
      </div>
    </section>
      
      
      


      <p>
        <a href="{% url 'reviews:index' product.pk %}">리뷰확인|{{ reviews.count }}|{{ total.review_avg|floatformat }}</a>
      </p>
      <p>
        <a href="{% url 'products:products_update' product.pk %}">수정하기</a>
      </p>
      <form action="{% url 'products:products_delete' product.pk  %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="상품 삭제">
      </form>
    </div>
    
    {% comment %} 리뷰/문의 모달 {% endcomment %}
    <section>
      <div class="overlayC hidden">
        <!--리뷰 모달-->
        <div id="review" class="modalC hidden">
          <div class="tit-area">
            <h1 class="tit">리뷰 쓰기</h1>
            <button class="btn-close btn-close-rev">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="item-area sect">
            <div class="img-area">
              <img src="{{product.product_image.all.0.image.url }}" alt="">
            </div>
            <div class="info">
              <p>{{ product.category }}</p>
              <h3 class="sub-tit">{{ product.name }}</h3>
            </div>
          </div>
          <div class="form-area ">
            <form action="{% url 'reviews:create' product.pk %}" class="review-form" method='POST' enctype="multipart/form-data">
              {% csrf_token %}
              <div class="rate-area sect">
                <h4 class="sub-tit">별점<span>*</span></h4>
                <div class="rate-stars">
                  <input type="radio" name="grade" id="rate-5" value="5">
                  <label for="rate-5">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-4" value="4">
                  <label for="rate-4">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-3" value="3">
                  <label for="rate-3">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-2" value="2">
                  <label for="rate-2">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-1" value="1">
                  <label for="rate-1">
                    <i class="bi bi-star-fill"></i>
                  </label>
                </div>
              </div>
              <div class="review-img sect">
                <h4 class="sub-tit">사진 첨부</h4>
                <span>사진을 첨부해주세요 (최대 1장)</span>
                <label for="file" class="upload-btn">
                  <i class="bi bi-card-image"></i>
                  <span>
                    사진첨부하기</span>
                </label>
                <input type="file" accept="image/jpeg" name="review_image" id="file"/>
              </div>
              <div class="review-txt sect">
                <h4 class="sub-tit">리뷰 작성<span>*</span></h4>
                <input type="text" name="title" placeholder="리뷰 제목을 작성해주세요">
                <textarea name="content" id="review-content" cols="120" rows="10" placeholder="자세하고 솔직한 리뷰는 다른 고객에게 큰 도움이 됩니다. (최소 20자 이상)"></textarea>
              </div>
              <button class="btnC" type="submit">완료</button>
            </form>
          </div>
        </div>
        <!--문의 모달-->
        <div id="qna" class="modalC hidden">
          <div class="tit-area">
            <h1 class="tit">상품 문의하기</h1>
            <button class="btn-close btn-close-qna">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="qna-cate">
            <h3 class="sub-tit">문의유형</h3>
            <table class="cate-area sect">
              <tbody>
                <tr>
                  <td class="tab_oper tab-active">상품</td>
                  <td class="tab_oper">배송</td>
                  <td class="tab_oper">반품</td>
                </tr>
                <tr>
                  <td class="tab_oper">교환</td>
                  <td class="tab_oper">환불</td>
                  <td class="tab_oper">기타</td>
                </tr>
              </tbody>
            </table>
          </div>
          <h3 class="sub-tit">상품</h3>
          <div class="item-area sect">
            <div class="img-area">
              <img src="{{product.product_image.all.0.image.url }}" alt="">
            </div>
            <div class="info">
              <p>{{ product.category }}</p>
              <h3 class="sub-tit">{{ product.name }}</h3>
            </div>
          </div>
          <div class="form-area ">
            <form action="" class="qna-form">
              <div class="qna-txt sect">
                <h4 class="sub-tit">문의내용</h4>
                <textarea name="review-content" id="review-content" cols="120" rows="10" placeholder="문의내용을 입력하세요."></textarea>
              </div>
              <button class="btnC" type="submit">완료</button>
            </form>
          </div>
        </div>
        <!--리뷰 수정 모달-->
        <div id="review_update" class="modalC hidden">
          <div class="tit-area">
            <h1 class="tit">리뷰 수정</h1>
            <button class="btn-close btn-close-rev">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="item-area sect">
            <div class="img-area">
              <img src="{{product.product_image.all.0.image.url }}" alt="">
            </div>
            <div class="info">
              <p>{{ product.category }}</p>
              <h3 class="sub-tit">{{ product.name }}</h3>
            </div>
          </div>
          <div class="form-area ">
            <form action="" class="review-form" method='POST' enctype="multipart/form-data">
              {% csrf_token %}
              <div class="rate-area sect">
                <h4 class="sub-tit">별점<span>*</span></h4>
                <div class="rate-stars">
                  <input type="radio" name="grade" id="rate-5" value="5">
                  <label for="rate-5">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-4" value="4">
                  <label for="rate-4">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-3" value="3">
                  <label for="rate-3">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-2" value="2">
                  <label for="rate-2">
                    <i class="bi bi-star-fill"></i>
                  </label>
                  <input type="radio" name="grade" id="rate-1" value="1">
                  <label for="rate-1">
                    <i class="bi bi-star-fill"></i>
                  </label>
                </div>
              </div>
              <div class="review-img sect">
                <h4 class="sub-tit">사진 첨부</h4>
                <span>사진을 첨부해주세요 (최대 1장)</span>
                <label for="file" class="upload-btn">
                  <i class="bi bi-card-image"></i>
                  <span>
                    사진첨부하기</span>
                </label>
                <input type="file" accept="image/jpeg" name="review_image" id="file"/>
              </div>
              <div class="review-txt sect">
                <h4 class="sub-tit">리뷰 작성<span>*</span></h4>
                <input type="text" name="title" placeholder="리뷰 제목을 작성해주세요">
                <textarea name="content" id="review-content" cols="120" rows="10" placeholder="자세하고 솔직한 리뷰는 다른 고객에게 큰 도움이 됩니다. (최소 20자 이상)"></textarea>
              </div>
              <button class="btnC" type="submit">완료</button>
            </form>
          </div>
        </div>
      </div>    
    </section>
  </main>

  <!-- 찜하기 script -->
  <script>
    const forms = document.querySelectorAll('.like-forms')
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value;

    forms.forEach((form) => {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const productId = event
          .target
          .dataset
          .productId
          axios({
            method: 'post',
            url: `/products/${productId}/like/`,
            headers: {
              'X-CSRFToken': csrftoken
            }, // csrf token
          })
          .then((response) => {
            const isLiked = response.data.is_liked
            const likeBtn = document.querySelector(`#like-${productId}`)
            const heartBtn = document.querySelector(`#heart-${productId}`)
            const likeCountTag = document.querySelector('#heart-count')
            const likeCount = response.data.like_count
            likeCountTag.innerText = likeCount
            if (isLiked === true) {
              heartBtn
                .classList
                .remove('bi-bookmark-heart')
              heartBtn
                .classList
                .add('bi-bookmark-heart-fill')
            } else {
              heartBtn
                .classList
                .remove('bi-bookmark-heart-fill')
              heartBtn
                .classList
                .add('bi-bookmark-heart')
            }
          })
      })
    })
  </script>
{% endblock body %}

{% block js %}
<script src="{% static 'script/pdt-detail.js' %}"></script>
{% endblock js %}
